(function(a){a.fn.bPopup=function(u,E){if(a.isFunction(u)){E=u;u=null}var J=a.extend({},a.fn.bPopup.defaults,u);if(!J.scrollBar){a("html").css("overflow","hidden")}var f=this,k=a(this),S=a(document),F=window,T=a(F),p=Q(),j=O(),D="__b-popup",N=(/OS 6(_\d)+/i).test(navigator.userAgent),s=200,e=0,C,r,n,B,v,G,V,c,b,i,z;f.close=function(){M();K()};f.reposition=function(d){q(d)};return f.each(function(){if(a(this).data("bPopup")){return}L()});function M(){h(J.onOpen);e=(T.data("bPopup")||0),C=D+e+"__",n=J.position[1]!=="auto",B=J.position[0]!=="auto",v=J.positionStyle==="fixed",c=f.outerHeight(true),b=f.outerWidth(true)}function K(){if(J.modal){a(".b-modal."+C).fadeTo(J.speed,0,function(){a(this).remove()})}U();clearTimeout(z);R();return false}function L(){h(J.onOpen);e=(T.data("bPopup")||0)+1,C=D+e+"__",n=J.position[1]!=="auto",B=J.position[0]!=="auto",v=J.positionStyle==="fixed",c=f.outerHeight(true),b=f.outerWidth(true);J.loadUrl?y():t()}function y(){J.contentContainer=a(J.contentContainer||f);switch(J.content){case ("iframe"):var d=a('<iframe class="b-iframe" '+J.iframeAttr+"></iframe>");d.appendTo(J.contentContainer);c=f.outerHeight(true);b=f.outerWidth(true);t();d.attr("src",J.loadUrl);h(J.loadCallback);break;case ("image"):t();a("<img />").load(function(){h(J.loadCallback);g(a(this))}).attr("src",J.loadUrl).hide().appendTo(J.contentContainer);break;default:t();a('<div class="b-ajax-wrapper"></div>').load(J.loadUrl,J.loadData,function(w,o,W){h(J.loadCallback,o);g(a(this))}).hide().appendTo(J.contentContainer);break}}function t(){if(J.modal){a('<div class="b-modal '+C+'"></div>').css({backgroundColor:J.modalColor,position:"fixed",top:0,right:0,bottom:0,left:0,opacity:0,zIndex:J.zIndex+e}).appendTo(J.appendTo).fadeTo(J.speed,J.opacity)}x();f.data("bPopup",J).data("id",C).css({left:J.transition=="slideIn"||J.transition=="slideBack"?(J.transition=="slideBack"?S.scrollLeft()+j:(V+b)*-1):I(!(!J.follow[0]&&B||v)),position:J.positionStyle||"absolute",top:J.transition=="slideDown"||J.transition=="slideUp"?(J.transition=="slideUp"?S.scrollTop()+p:G+c*-1):m(!(!J.follow[1]&&n||v)),"z-index":J.zIndex+e+1}).each(function(){if(J.appending){a(this).appendTo(J.appendTo)}});R(true)}function H(){console.log(C,f.data("id"),f.data("bPopup"));if(J.modal){a(".b-modal."+f.data("id")).fadeTo(J.speed,0,function(){a(this).remove()})}U();clearTimeout(z);R();return false}function q(d){p=Q();j=O();r=A();if(r){clearTimeout(i);i=setTimeout(function(){x();d=d||J.followSpeed;f.dequeue().each(function(){if(v){a(this).css({left:V,top:G})}else{a(this).animate({left:J.follow[0]?I(true):"auto",top:J.follow[1]?m(true):"auto"},d,J.followEasing)}})},50)}}function g(W){var d=W.width(),w=W.height(),o={};J.contentContainer.css({height:w,width:d});if(w>=f.height()){o.height=f.height()}if(d>=f.width()){o.width=f.width()}c=f.outerHeight(true),b=f.outerWidth(true);x();J.contentContainer.css({height:"auto",width:"auto"});o.left=I(!(!J.follow[0]&&B||v)),o.top=m(!(!J.follow[1]&&n||v));f.animate(o,250,function(){W.show();r=A()})}function P(){T.data("bPopup",e);f.delegate(".bClose, ."+J.closeClass,"click."+C,H);if(J.modalClose){a(".b-modal."+C).css("cursor","pointer").bind("click",H)}if(!N&&(J.follow[0]||J.follow[1])){T.bind("scroll."+C,function(){if(r){f.dequeue().animate({left:J.follow[0]?I(!v):"auto",top:J.follow[1]?m(!v):"auto"},J.followSpeed,J.followEasing)}}).bind("resize."+C,function(){q()})}if(J.escClose){S.bind("keydown."+C,function(d){if(d.which==27){H()}})}}function U(){if(!J.scrollBar){a("html").css("overflow","auto")}a(".b-modal."+C).unbind("click");S.unbind("keydown."+C);T.unbind("."+C).data("bPopup",(T.data("bPopup")-1>0)?T.data("bPopup")-1:null);f.undelegate(".bClose, ."+J.closeClass,"click."+C,H).data("bPopup",null)}function R(o){switch(o?J.transition:J.transitionClose||J.transition){case"slideIn":d({left:o?I(!(!J.follow[0]&&B||v)):S.scrollLeft()-(b||f.outerWidth(true))-s});break;case"slideBack":d({left:o?I(!(!J.follow[0]&&B||v)):S.scrollLeft()+j+s});break;case"slideDown":d({top:o?m(!(!J.follow[1]&&n||v)):S.scrollTop()-(c||f.outerHeight(true))-s});break;case"slideUp":d({top:o?m(!(!J.follow[1]&&n||v)):S.scrollTop()+p+s});break;case"fadeOut":k.hide();f.stop().fadeOut(J.speed);break;default:f.stop().fadeTo(J.speed,o?1:0,function(){l(o)})}function d(w){f.css({display:"block",opacity:1}).animate(w,J.speed,J.easing,function(){l(o)})}}function l(d){if(d){P();h(E);if(J.autoClose){z=setTimeout(H,J.autoClose)}}else{f.hide();h(J.onClose);if(J.loadUrl){J.contentContainer.empty();f.css({height:"auto",width:"auto"})}}}function I(d){return d?V+S.scrollLeft():V}function m(d){return d?G+S.scrollTop():G}function h(o,d){a.isFunction(o)&&o.call(f,d)}function x(){G=n?J.position[1]:Math.max(0,((p-f.outerHeight(true))/2)-J.amsl),V=B?J.position[0]:(j-f.outerWidth(true))/2,r=A()}function A(){return p>f.outerHeight(true)&&j>f.outerWidth(true)}function Q(){return F.innerHeight||T.height()}function O(){return F.innerWidth||T.width()}};a.fn.bPopup.defaults={amsl:50,appending:true,appendTo:"body",autoClose:false,closeClass:"b-close",content:"ajax",contentContainer:false,easing:"swing",escClose:true,follow:[true,true],followEasing:"swing",followSpeed:500,iframeAttr:'scrolling="no" frameborder="0"',loadCallback:false,loadData:false,loadUrl:false,modal:true,modalClose:true,modalColor:"#000",onClose:false,onOpen:false,opacity:0.7,position:["auto","auto"],positionStyle:"absolute",scrollBar:true,speed:250,transition:"fadeIn",transitionClose:false,zIndex:9997}})(jQuery);